<? namespace Bitrix\Main\Security\W;$GLOBALS['____1586757001']= array(base64_decode('dGl'.'tZQ=='),base64_decode('d'.'Gl'.'tZQ=='),base64_decode('anNvbl9kZ'.'WNvZ'.'G'.'U='),base64_decode('YX'.'JyY'.'Xlfb'.'W'.'V'.'yZ2U='),base64_decode('am9'.'pbg=='),base64_decode('a'.'m9'.'pbg=='),base64_decode('am'.'9'.'pbg=='),base64_decode('YXJyYX'.'l'.'fcG9'.'w'),base64_decode('YXJyYXlfc'.'2hp'.'ZnQ='),base64_decode('Y'.'X'.'JyYXlfc2hpZn'.'Q='),base64_decode('YXJy'.'YXlfc2hpZnQ'.'='),base64_decode('YX'.'J'.'yYXlfc2hpZn'.'Q='),base64_decode('YXJy'.'YX'.'l'.'f'.'b'.'WVyZ2U='),base64_decode(''.'aXNfYXJyYXk='),base64_decode(''.'YXJy'.'YXlfbWV'.'yZ2U='),base64_decode('a'.'W5'.'fYXJyYXk'.'='),base64_decode('aW5fYXJy'.'YX'.'k='),base64_decode('a'.'W5f'.'YXJyYX'.'k='),base64_decode(''.'a'.'W5'.'fYXJy'.'YXk='),base64_decode('aW5f'.'YXJy'.'YXk='),base64_decode('dGl'.'tZQ=='),base64_decode(''.'dGltZ'.'Q'.'='.'='),base64_decode('YXJyY'.'Xlf'.'b'.'WFw'),base64_decode('Z2V0X2xvY'.'WRlZF'.'9leHRl'.'b'.'nNp'.'b'.'25z'),base64_decode(''.'anNvbl9'.'lb'.'mNvZG'.'U='),base64_decode('a'.'nN'.'vbl9l'.'bmNvZ'.'GU='),base64_decode('cGh'.'wdmVyc2lvb'.'g=='),base64_decode('anNvbl'.'9lbm'.'N'.'vZG'.'U='),base64_decode(''.'am'.'9'.'pb'.'g=='));if(!function_exists(__NAMESPACE__.'\\___1715455205')){function ___1715455205($_566715342){static $_1056399550= false; if($_1056399550 == false) $_1056399550=array('V1dBT'.'Exf'.'TE9DSw'.'==','c2'.'VjdXJp'.'d'.'H'.'k'.'=','R'.'EFUQQ==',''.'e'.'yI=','V1'.'dB'.'TExfT'.'E9D'.'Sw'.'='.'=','c2V'.'jdXJ'.'pdHk=',''.'U0'.'VDVVJJ'.'VFl'.'f'.'V1'.'dB'.'TExf'.'RVhDRVB'.'US'.'U9'.'O','RkFJ'.'T'.'F'.'9'.'DSEV'.'DS0lOR'.'w==','Q2FuI'.'G5v'.'dCBleG'.'V'.'jdXRlIH'.'d3'.'YWxsIHJ1bG'.'VzO'.'iA'.'=','IFR'.'yYWN'.'lOi'.'A'.'=',''.'UkVR'.'VUV'.'T'.'VF9VUkk'.'=',''.'a2V5cw==','dmFs'.'dWVz','U0VDVVJJ'.'VFl'.'fV'.'1dBTExfTU'.'9'.'ES'.'UZZ','Lg==','U'.'0VDV'.'VJJVFlf'.'V1dB'.'T'.'E'.'xfVU5TRVQ=','Lg==',''.'U0VDV'.'VJ'.'JVFl'.'fV1dB'.'TExf'.'RVhJVA==','Lg'.'==',''.'Z'.'2xvYmFs','a2V5cw'.'==','dmFsd'.'WVz','Z2V0','Z'.'2V0','cG9'.'zdA==','c'.'G'.'9zdA==','Y2'.'9v'.'a2ll','Y29va2'.'ll','cmV'.'xdWVz'.'dA==','cm'.'Vxd'.'WVzdA==','Z2xvYm'.'Fs','Z2xv'.'YmF'.'s','bWFp'.'bl'.'9z'.'ZWM=','V1dBTExfQ'.'U'.'NUVUFMSVpFX1JVTE'.'VT','d'.'g'.'==','dm'.'Vyc2lvbg='.'=','a'.'Q==','aXNJb'.'nN0Y'.'W'.'xs'.'ZW'.'Q=','dg==','a'.'W5p','bW9k'.'dWxl'.'cw='.'=',''.'bGljZW5zZQ==','cG'.'h'.'w','dg==','ZX'.'h0',''.'c2VjdXJpdHk=','ZGI=','dHlwZQ==','ZGI=','dm'.'Vyc2lvbg==','Z'.'G'.'I=',''.'d'.'HlwZQ'.'='.'=','Z'.'GI=','dHlwZ'.'Q==','dmVyc2lv'.'b'.'g='.'=','ZGI=','d'.'mV'.'yc2lv'.'bg==','Z'.'W52a'.'XJvbm1lbnQ=','dm1f'.'dm'.'Vyc2'.'lvbg==','dm0=','d'.'g='.'=','ZW52aXJvbm1lbnQ=','d'.'m'.'1fdmVyc2lvbg==',''.'c2'.'9ja2V0VGl'.'tZ'.'W9'.'1dA'.'==',''.'c'.'3R'.'y'.'ZWFt'.'V'.'GltZW91dA==','KCc=','ZGF0YQ==','JywgJw==','bW'.'9kdWxl','J'.'y'.'wgJw==','bW9kd'.'W'.'x'.'lX3'.'Z'.'lcnNp'.'b24'.'=','Jyk=','LC'.'A=','U0'.'VD'.'VVJJ'.'VFlfV1'.'dBTExfRVhD'.'RVBUS'.'U'.'9O','bW'.'Fpbg'.'==','RkFJTF9SRUZSRVN'.'ISU5H','Q2FuIG5vdCByZWZy'.'ZXNoI'.'H'.'d3YWxs'.'IH'.'J1'.'b'.'GVzOiA=','IFRy'.'YWNlOiA=','ZG'.'F0Y'.'Q'.'='.'=','eyI'.'=','LS0tLS1CRUdJTi'.'B'.'QVUJMSUMgS0'.'V'.'ZLS0tLS0=','Ck1JS'.'UJJak'.'FOQmdrcWh'.'raUc5dzBCQVFFRkFBT0N'.'BUT'.'hBTU'.'lJQkNnS0NBUUVBc'.'T'.'h'.'RRTBIam'.'1ISlVT'.'dF'.'dWNm'.'4'.'w'.'emEKUlZvTHgwMkt6YmZy'.'YlM'.'vUDZzV2F4VHp3'.'OF'.'NlR1R0YlRDT3Jw'.'SGk1UUY2'.'T1J'.'5alo'.'vWHh6L'.'0tMVT'.'FHYm9mOUN'.'a'.'Mwo'.'0ejdTa'.'3FVd'.'DY2aWJYdk9GQ'.'ng'.'0Znc'.'v'.'Q'.'VB'.'Q'.'U'.'kdEcXRtMG5EM2'.'ZnR'.'3N1M1J'.'lUG'.'d3'.'MjlpOCt2b'.'TdtdEJ'.'L'.'SlVZbD'.'R'.'yCl'.'Zw'.'YjZzZlp'.'F'.'V'.'DlLRWI2'.'VDFIR'.'FltRX'.'Z'.'jM'.'W'.'hxL'.'2lpdX'.'l'.'4T'.'HJaWmk'.'1UTZ'.'VZmY0VUV2VE'.'krN'.'jhzc0Z'.'Sa1'.'E'.'rb3d'.'UUnkKZ'.'U9JTWJGaE0v'.'VVRt'.'Z'.'lZZYlRSRn'.'kyb1'.'VROF'.'dNemEybko1U2Fo'.'emkxVUtPM'.'WpB'.'alhUUFJyemM'.'3QWp'.'1NjM'.'5ajFPM'.'A'.'pwcH'.'Fm'.'bTV4Z1'.'dsRkFKa0'.'hRVGdiZ'.'GQ1Q'.'Vdx'.'REZR'.'a3Q'.'5'.'SE'.'t'.'rWStUbmZCTEdWTXZWeV'.'B3VEhOV1F'.'ZQXc0'.'eHBnL3dBClp'.'3SURBUUFCCi0tLS0'.'tRU5EIFBVQk'.'xJQyBL'.'RVktL'.'S0tLQ==');return base64_decode($_1056399550[$_566715342]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1020219764= 'https://wwall.bitrix.info/rules.php'; protected $_547254982= true; public function handle(){ try{  $_1841143443= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1841143443)){ return;}  $_398253076= Cache::createInstance(); $_1490738797= false; if($_398253076->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_59576218= $_398253076->getVars(); if($GLOBALS['____1586757001'][0]()- $_59576218> round(0+6.6666666666667+6.6666666666667+6.6666666666667)){  $_1073848138= Application::getConnection(); $_73816213= RuleRecordTable::getTableName(); $_1073848138->truncateTable($_73816213); RuleRecordTable::cleanCache(); $_398253076->clean(___1715455205(0), ___1715455205(1));}} elseif($_398253076->startDataCache()){  $_398253076->endDataCache($GLOBALS['____1586757001'][1]()); $_1490738797= true;} foreach($_1841143443 as $_1933141067){ $_1158259535= new PublicKeyCipher; $_747932615= $_1158259535->decrypt($_1933141067[___1715455205(2)], static::__645857286()); if(!str_starts_with($_747932615, ___1715455205(3))){ continue;} $_2039870264= $GLOBALS['____1586757001'][2]($_747932615, true); if(!empty($_2039870264)){ $_837602831= Rule::make($_2039870264); $_428092823= $this->handleRule($_837602831); $this->applyHandlingResults($_428092823);}}  if($_1490738797){ $_398253076->clean(___1715455205(4), ___1715455205(5));}} catch(\Throwable $_723814220){ $this->logEvent( ___1715455205(6), ___1715455205(7), ___1715455205(8). $_723814220->getMessage(). ___1715455205(9). $_723814220->getTraceAsString());}}  public function handleRule(Rule $_837602831): array{ $_428092823=[]; if($_837602831->matchPath($_SERVER[___1715455205(10)])){  $_439396027= $this->getContextElements($_837602831->getContext()); foreach($_439396027 as $_895141948 => &$_267402373){ $_428092823= $GLOBALS['____1586757001'][3]($_428092823, $this->recursiveContextKeyHandle($_895141948, $_267402373,[], $_837602831));}} return $_428092823;}  public function applyHandlingResults(array $_428092823){ $_439396027= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_428092823 as $_712081530){ $_267402373=& $_439396027[$_712081530->getContextName()]; $_1453505152= $_712081530->getRuleResult(); $_837602831= $_712081530->getRule(); if($_1453505152 instanceof ModifyResult){ if($_837602831->getProcess() === ___1715455205(11)){  static::rewriteContextKey( $_712081530->getContextName(), $_267402373, $_712081530->getContextKey(), $_1453505152->getCleanValue());} elseif($_837602831->getProcess() === ___1715455205(12)){ static::rewriteContextValue( $_712081530->getContextName(), $_267402373, $_712081530->getContextKey(), $_1453505152->getCleanValue());} $this->logEvent( ___1715455205(13), $_712081530->getContextName(), $GLOBALS['____1586757001'][4](___1715455205(14), $_712081530->getContextKey()));} elseif($_1453505152 instanceof CheckResult &&!$_1453505152->isSuccess()){ if($_1453505152->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_712081530->getContextName(), $_267402373, $_712081530->getContextKey(),); $this->logEvent( ___1715455205(15), $_712081530->getContextName(), $GLOBALS['____1586757001'][5](___1715455205(16), $_712081530->getContextKey()));} elseif($_1453505152->getAction() === RuleAction::EXIT){ $this->logEvent( ___1715455205(17), $_712081530->getContextName(), $GLOBALS['____1586757001'][6](___1715455205(18), $_712081530->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_547254982= false;} protected function rewriteContextKey($_895141948, &$_267402373, $_279722520, $_1526675509){ $_231145853= $_279722520;  $GLOBALS['____1586757001'][7]($_231145853); $_231145853[]= $_1526675509; if($_895141948 === ___1715455205(19)){ $_1822191903= $GLOBALS['____1586757001'][8]($_279722520); $GLOBALS['____1586757001'][9]($_231145853); if(empty($_279722520)){ $GLOBALS[$_1526675509]= $GLOBALS[$_1822191903]; unset($GLOBALS[$_1822191903]);} else{ $_267402373=& $GLOBALS[$_1822191903]; $_992037012= ArrayHelper::getByNestedKey($_267402373, $_279722520);  ArrayHelper::setByNestedKey($_267402373, $_231145853, $_992037012);  ArrayHelper::unsetByNestedKey($_267402373, $_279722520);}} else{ $_992037012= ArrayHelper::getByNestedKey($_267402373, $_279722520);  ArrayHelper::setByNestedKey($_267402373, $_231145853, $_992037012);  ArrayHelper::unsetByNestedKey($_267402373, $_279722520);}} protected function rewriteContextValue($_895141948, &$_267402373, $_1876933601, $_992037012){ if($_895141948 === 'global'){ $_1822191903= $GLOBALS['____1586757001'][10]($_1876933601); if(empty($_1876933601)){ $GLOBALS[$_1822191903]= $_992037012;} else{ $_267402373=& $GLOBALS[$_1822191903]; ArrayHelper::setByNestedKey($_267402373, $_1876933601, $_992037012);}} else{  ArrayHelper::setByNestedKey($_267402373, $_1876933601, $_992037012);}} protected function unsetContextValue($_895141948, &$_267402373, $_1876933601){ if($_895141948 === 'global'){ $_1822191903= $GLOBALS['____1586757001'][11]($_1876933601); if(empty($_1876933601)){ unset($GLOBALS[$_1822191903]);} else{ $_267402373=& $GLOBALS[$_1822191903]; ArrayHelper::unsetByNestedKey($_267402373, $_1876933601);}} else{ ArrayHelper::unsetByNestedKey($_267402373, $_1876933601);}}  protected function recursiveContextKeyHandle(string $_895141948, array &$_267402373, array $_398947109, Rule $_837602831): array{  $_428092823=[]; foreach($_267402373 as $_700945377 => $_992037012){ $_1876933601= $GLOBALS['____1586757001'][12]($_398947109,[$_700945377]); if($_837602831->matchKey($_1876933601)){  if($_837602831->getProcess() === ___1715455205(20)){ $_1453505152= $_837602831->evaluate($_700945377);} elseif($_837602831->getProcess() === ___1715455205(21)){ $_1453505152= $_837602831->evaluateValue($_992037012);}  if(!empty($_1453505152) && $_1453505152 instanceof RuleResult){ $_428092823[]= new HandlingResult($_895141948, $_1876933601, $_1453505152, $_837602831);}}  if($GLOBALS['____1586757001'][13]($_992037012)){ $_428092823= $GLOBALS['____1586757001'][14]($_428092823, $this->recursiveContextKeyHandle( $_895141948, $_267402373[$_700945377], $_1876933601, $_837602831));}} return $_428092823;} protected function getContextElements(array $_1290591724){ $_1588729657=[]; if($GLOBALS['____1586757001'][15](___1715455205(22), $_1290591724, true)){ $_1588729657[___1715455205(23)]= &$_GET;} if($GLOBALS['____1586757001'][16](___1715455205(24), $_1290591724, true)){ $_1588729657[___1715455205(25)]= &$_POST;} if($GLOBALS['____1586757001'][17](___1715455205(26), $_1290591724, true)){ $_1588729657[___1715455205(27)]= &$_COOKIE;} if($GLOBALS['____1586757001'][18](___1715455205(28), $_1290591724, true)){ $_1588729657[___1715455205(29)]= &$_REQUEST;} if($GLOBALS['____1586757001'][19](___1715455205(30), $_1290591724, true)){ $_1588729657[___1715455205(31)]= $GLOBALS;} return $_1588729657;} public static function refreshRules(){ try{ $_78006440= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1586757001'][20]()- $_78006440)< static::CACHE_RULES_TTL){ return;} Option::set(___1715455205(32), ___1715455205(33), $GLOBALS['____1586757001'][21]()); $_1646418625= null;  $_672326581= $GLOBALS['____1586757001'][22](function($_1547839651){ return[___1715455205(34) => $_1547839651[___1715455205(35)], ___1715455205(36) => (int) $_1547839651[___1715455205(37)]];}, ModuleManager::getModulesFromDisk());  $_1186252190=[]; foreach($GLOBALS['____1586757001'][23]() as $_555651886){ $_953416450= new ReflectionExtension($_555651886); $_1186252190[$_555651886]=[ ___1715455205(38) => $_953416450->getVersion(), ___1715455205(39) => $_953416450->getINIEntries()];} $_499358447=[ ___1715455205(40) => $GLOBALS['____1586757001'][24]($_672326581), ___1715455205(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1715455205(42) => $GLOBALS['____1586757001'][25]([ ___1715455205(43) => $GLOBALS['____1586757001'][26](), ___1715455205(44) => $_1186252190])]; if(Loader::includeModule(___1715455205(45))){ $_943935239= CSecuritySystemInformation::getSystemInformation(); if(isset($_943935239[___1715455205(46)][___1715455205(47)]) && isset($_943935239[___1715455205(48)][___1715455205(49)])){ $_499358447[___1715455205(50)]=[ ___1715455205(51) => $_943935239[___1715455205(52)][___1715455205(53)], ___1715455205(54) => $_943935239[___1715455205(55)][___1715455205(56)]];} if(isset($_943935239[___1715455205(57)][___1715455205(58)])){ $_499358447[___1715455205(59)]=[___1715455205(60) => $_943935239[___1715455205(61)][___1715455205(62)]];}}  $_1090306018= new HttpClient([ ___1715455205(63) => round(0+2.5+2.5), ___1715455205(64) => round(0+5)]); $_244172207= $_1090306018->post( static::$_1020219764, $_499358447); if($_1090306018->getStatus() == round(0+100+100) &&!empty($_244172207)){ $_1646418625= Json::decode($_244172207);}  if($_1646418625 !== null){ $_1073848138= Application::getConnection(); $_73816213= RuleRecordTable::getTableName(); if(!empty($_1646418625)){ foreach($_1646418625 as $_1534678897){ if(!static::checkRuleSign($_1534678897)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1586757001'][27]($_1534678897));}}}  $_1073848138->truncateTable($_73816213);  if(!empty($_1646418625)){ $_1808772099=[]; foreach($_1646418625 as $_1534678897){ $_1808772099[]= ___1715455205(65). $_1073848138->getSqlHelper()->forSql($_1534678897[___1715455205(66)]). ___1715455205(67). $_1073848138->getSqlHelper()->forSql($_1534678897[___1715455205(68)]). ___1715455205(69). $_1073848138->getSqlHelper()->forSql($_1534678897[___1715455205(70)]). ___1715455205(71);} $_710319956= $GLOBALS['____1586757001'][28](___1715455205(72), $_1808772099);  $_1073848138->query("INSERT INTO {$_73816213} (DATA, MODULE, MODULE_VERSION) VALUES {$_710319956}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_723814220){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1715455205(73), ___1715455205(74), ___1715455205(75), ___1715455205(76). $_723814220->getMessage(). ___1715455205(77). $_723814220->getTraceAsString());}} protected static function checkRuleSign($_837602831){ $_1158259535= new PublicKeyCipher; $_2039870264= $_1158259535->decrypt($_837602831[___1715455205(78)], static::__645857286()); return str_starts_with($_2039870264, ___1715455205(79));} private static function __645857286(){ $_1693521116= ''; $_1693521116 .= ___1715455205(80); $_1693521116 .= ___1715455205(81); return $_1693521116;} protected function logEvent($_1227837666, $_965643002, $_1464883740){ if($this->_547254982){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1227837666, 'main', $_965643002, $_1464883740);}}}?>